name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    name: build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            archive: lazycompass-linux-x64.tar.gz
          - os: macos-14
            target: x86_64-apple-darwin
            archive: lazycompass-darwin-x64.tar.gz
          - os: macos-14
            target: aarch64-apple-darwin
            archive: lazycompass-darwin-arm64.tar.gz

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build
        run: cargo build --release -p lazycompass --target ${{ matrix.target }}

      - name: Package and checksum
        run: |
          tar -czf ${{ matrix.archive }} -C target/${{ matrix.target }}/release lazycompass
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum ${{ matrix.archive }} > ${{ matrix.archive }}.sha256
          else
            shasum -a 256 ${{ matrix.archive }} > ${{ matrix.archive }}.sha256
          fi

      - name: Import GPG key (optional)
        id: import_gpg
        env:
          RELEASE_GPG_PRIVATE_KEY: ${{ secrets.RELEASE_GPG_PRIVATE_KEY }}
          RELEASE_GPG_PASSPHRASE: ${{ secrets.RELEASE_GPG_PASSPHRASE }}
        run: |
          if [ -z "$RELEASE_GPG_PRIVATE_KEY" ] || [ -z "$RELEASE_GPG_PASSPHRASE" ]; then
            echo "fingerprint=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          printf '%s' "$RELEASE_GPG_PRIVATE_KEY" | gpg --batch --import
          key_fpr=$(gpg --list-secret-keys --with-colons | awk -F: '$1=="fpr"{print $10; exit}')
          echo "fingerprint=$key_fpr" >> "$GITHUB_OUTPUT"

      - name: Sign checksum (optional)
        if: ${{ steps.import_gpg.outputs.fingerprint != '' }}
        env:
          RELEASE_GPG_PASSPHRASE: ${{ secrets.RELEASE_GPG_PASSPHRASE }}
        run: |
          gpg --batch --yes --pinentry-mode loopback \
            --passphrase "$RELEASE_GPG_PASSPHRASE" \
            --local-user "${{ steps.import_gpg.outputs.fingerprint }}" \
            --output ${{ matrix.archive }}.sha256.sig \
            --detach-sign ${{ matrix.archive }}.sha256

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ matrix.archive }}
            ${{ matrix.archive }}.sha256

      - name: Upload signature (optional)
        if: ${{ steps.import_gpg.outputs.fingerprint != '' }}
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ matrix.archive }}.sha256.sig
